const { spawn } = require("child_process");
const path = require("path");
const fs = require("fs");
const convert = require("./converter");
const { uploadWithProgress } = require("../upload/uploader");

const STORAGE_DIR = path.join(__dirname, "../storage/temp");

let proc = null;

function startRecording(durationMinutes = 60, progressCb = () => {}, testSeconds = null){
  if (proc) {
    return Promise.reject(new Error("Recording already running"));
  }

  return new Promise((resolve, reject) => {
    const ts = Date.now();
    const base = `GM_${ts}`;
    const h264 = path.join(STORAGE_DIR, `${base}.h264`);
    const mp4 = path.join(STORAGE_DIR, `${base}.mp4`);

    const timeoutMs = testSeconds
  ? testSeconds * 1000
  : durationMinutes * 60 * 1000;


    console.log(`üé• Recording ${durationMinutes} min @720p60`);

    proc = spawn("rpicam-vid", [
      "--codec", "h264",
      "--inline",
      "--nopreview",
      "--width", "1280",
      "--height", "720",
      "--framerate", "60",
      "--profile", "high",
      "--level", "4.2",
      "--bitrate", "6000000",
      "--intra", "60",
      "--denoise", "off",
      "--timeout", timeoutMs.toString(),
      "-o", h264
    ]);

    proc.on("close", async (code) => {
      proc = null;

      if (code !== 0) return reject(new Error("Recording failed"));

      try {
        console.log("üé¨ Remuxing...");
        await convert(h264, mp4);

        console.log("‚òÅÔ∏è Uploading...");
        const url = await uploadWithProgress(
          mp4,
          `videos/${base}.mp4`,
          progressCb
        );

        fs.unlinkSync(h264);
        fs.unlinkSync(mp4);

        resolve(url);
      } catch (err) {
        reject(err);
      }
    });
  });
}

module.exports = { startRecording };
